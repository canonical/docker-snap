#!/bin/bash -u
# Detect if nvidia support enabled, and available, for a system type #

. "${SNAP}/usr/share/nvidia-container-toolkit/lib"

export NVIDIA_SUPPORT_CORE="false"
export NVIDIA_SUPPORT_CLASSIC="false"

if [ -L "/var/lib/snapd/hostfs/usr/lib/${ARCH_TRIPLET}/libcuda.so" ]; then
    export NVIDIA_SUPPORT_CLASSIC="true"
    echo "Running on Classic system"
elif snapctl is-connected gpu-2404 || snapctl is-connected graphics-core22; then
    export NVIDIA_SUPPORT_CORE="true"
    echo "Running on Ubuntu Core system"
else
    exit_inf "No NVIDIA support detected. For NVIDIA support, please refer to https://github.com/canonical/docker-snap"
fi

NVIDIA_SUPPORT_DISABLED="$(snapctl get nvidia-support.disabled)"
# Just exit if NVIDIA support is disabled #
[ "${NVIDIA_SUPPORT_DISABLED}" != "true" ] || exit_inf "NVIDIA support disabled by user"

## Running gpu-2404 wrapper for Core systems only ##

# Classic does not require this wrapper #
if [ "${NVIDIA_SUPPORT_CLASSIC}" == "true" ] ; then
    exec "$@"
fi

if [ "${NVIDIA_SUPPORT_CORE}" == "true" ] ; then
    if snapctl is-connected gpu-2404; then
        exec "${SNAP}/gpu-2404/bin/gpu-2404-provider-wrapper" "$@"
    fi

    # Core 22 does not require this wrapper #
    if snapctl is-connected graphics-core22  ; then
        exec "$@"
    fi

    exit_inf "GPU user-space content provider not connected."
fi
